<!DOCTYPE html>
<html>
<head>
	<title>test JS: replace text on page</title>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">

	<link type="text/css" rel="stylesheet" href="../../css/lr.css">
	<script src="../lib/shared_functions.js"></script>
</head>


<body class="bg-black-800 color-white">
	
<div class="lr-container color-white w80">
	<div class="lr-lr-page-header text-right">
		<h1 class="">test JS: replace text on page</h1>
	</div>
</div>
	
<div class="lr-container bg-saddlebrown w80">
<div class="_lr-row _text-center lr-flex lr-flex-wrap lr-flex-hcenter lr-flex-vtop">

		<div class="lr-panel w50 lr-margin-small">



			<div class="lr-panel-heading bg-vivid-teal color-black">
<h4>demo0, innerHTML, reset all events....</h4>
			</div>

			<div id="demo0" class="lr-panel-body bg-white color-black">
<div>RandomText1
	<div><p>RandomText2</p>
		<ul>
				<li class="test-event">
<span class='color-purple'>RandomText3</span>
				</li>
		</ul>
	</div>
</div>
<button id="btn0">replace all</button>
			</div>


			<div class="lr-panel-heading bg-vivid-orange3 color-black">
<h4>demo1, recurse method, node.childNodes.forEach...</h4>
			</div>

			<div id="demo1" class="lr-panel-body bg-white color-black">
<div>RandomText1
	<div><p>RandomText2</p>
		<ul>
				<li class="test-event">
<span class='color-blue'>RandomText3</span>
				</li>
		</ul>
	</div>
</div>
<button id="btn1">replace all</button>
			</div>





			<div class="lr-panel-heading bg-orange color-black">
<h4>demo2, TreeWalker</h4>
			</div>

			<div id="demo2" class="lr-panel-body bg-white color-black">
<ul>
	<li>
		<a id="ph1" href="tel:88007006951" class="color-blue header__phone" itemprop="telephone">8 800 700–69–51</a>
		<h1 class="test-event">8 800 700–69–51</h1>
	</li>
	<li><a href="tel:88007006951" class="color-brown header__phone" itemprop="telephone">8 800 700–69–51</a></li>
	<li><a href="tel:+78007006951" class="color-darkblue header__phone" itemprop="telephone">7 800 700-69-51</a></li>
	<li><a href="tel:+73833800101" class="color-red header__phone" itemprop="telephone">8 383 380–01–01</a></li>
	<li><a href="tel:+73833800101" class="color-darkred header__phone" itemprop="telephone">8 (383) 380-01-01</a></li>
</ul>
		<div>div.text: 8 383 380–01–01</div>
<div class="front-page__top-slider__slide__title">ВЫЗОВ СПЕЦИАЛИСТА - 8 (383) 380-01-01</div>

<button id="btn2">replace (regexp)</button>
<button id="btn-replace-phone">replace-phone (filter number)</button>
			</div>


			<div class="lr-panel-heading bg-darkred color-gold">
<h4>demo3, nodeIterator</h4>
			</div>

			<div id="demo3" class="lr-panel-body bg-white color-black">
<div>
  <div>
    RandomText1
    <div class="test-event color-green">
RandomText2
    </div>
  </div>
</div>
<div>
  <div>
    <div>
      <div>
        <div>
          <div class='color-red'>
            6 Deep!
          </div>
        </div>
      </div>
    </div>
  </div>
  <div>
    RandomText1
    <div>
      RandomText2
    </div>
  </div>
</div>
<div>
  <div>
    RandomText1
    <div>
      RandomText2
    </div>
  </div>
</div>
<div>
  <div>
    RandomText1
    <div>
      RandomText2
    </div>
  </div>
</div>
<div>
  <div>
    RandomText1
    <div>
      RandomText2
    </div>
  </div>
</div>

<button id="btn-iteraror">replace all</button>
			</div>


		</div><!-- end panel -->

		<div class="lr-panel lr-margin-small">
			<div class="lr-panel-heading bg-vivid-orange5 color-black">
<div class="lr-flex lr-flex-vcenter lr-flex-hbetween">				
	<i class="dashicons dashicons-admin-network lr-margin-10"></i>
	<h4>info</h4>
</div>
			</div>
			
			<div class="lr-panel-body bg-white color-black">
<pre>
---------------- Replace
https://developer.mozilla.org/en-US/docs/Web/API/NodeIterator
NodeIterator

https://developer.mozilla.org/en-US/docs/Web/EXSLT/regexp/replace
regexp:replace()

https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace
String.prototype.replace()

http://code.mu/ru/javascript/book/supreme/regular/callback-in-replace-method/
Коллбэк в методе replace в регулярках JavaScript

---------------- TreeWalker
https://developer.mozilla.org/en-US/docs/Web/API/TreeWalker
TreeWalker

http://javascriptkit.com/dhtmltutors/treewalker.shtml
Introduction to the TreeWalker object of DOM

https://techarks.ru/qa/javascript/zamena-teksta-s-pomoshyu-tree-NP/
Замена текста с помощью Treewalker в расширении Chrome

--------------
https://question-it.com/questions/290767/bolee-bystryj-sposob-zameny-teksta-vo-vseh-elementah-dom
быстрый способ замены текста во всех элементах dom

https://coderlessons.com/articles/veb-razrabotka-articles/masterstvo-html5-obkhod-dereva
Мастерство HTML5: обход дерева

</pre>
				
			</div>
		</div><!-- end panel -->

	</div><!-- end center row -->
	
	<div class="log-panel panel">
		<div class="float-right">
<!--			<a href="?q=toggle-log" title="Toggle log" class="lr-btn lr-btn-default">-</a> -->
			<a href="?q=clear-log" title="Clear log" id="btn-clear-log" class="lr-btn lr-btn-default">x</a>
		</div>
		<div id="log" class="lr-panel-body lr-row"></div>
	</div>

</div><!-- end container -->


<script>
var func = sharedFunc();
//console.log("func:", func);

var _testObj = {
	"logMsg": "",
	"support": func.testSupport()
};
console.log( _testObj );


document.addEventListener("DOMContentLoaded", function(e){
	_testObj.logMsg = navigator.userAgent;
	func.logAlert( _testObj.logMsg, "info");
	

	_testObj.logMsg = "window.TreeWalker: "+_testObj["support"]["TreeWalker"];
	func.logAlert( _testObj.logMsg, "info");

	_testObj.logMsg = "window.NodeIterator: "+_testObj["support"]["NodeIterator"];
	func.logAlert( _testObj.logMsg, "info");

	//init test object
	_testObj["log"] = func.getById("log");
	_testObj["btn_clear_log"] = func.getById("btn-clear-log");

	_testObj["btn_clear_log"].onclick = function( event ){
//console.log("click...", e);
		event = event || window.event;
		var target = event.target || event.srcElement;
		if (event.preventDefault) {
			event.preventDefault();
		} else {
			event.returnValue = false;
		}
		_testObj.log.innerHTML = "";
	};//end event

//-------------- DEMO1
//https://question-it.com/questions/290767/bolee-bystryj-sposob-zameny-teksta-vo-vseh-elementah-dom
	var sourceText = "RandomText";
	var replaceText = "Hello world";
	function replaceTextNodes(node) {
		node.childNodes.forEach( function(el) {

			if (el.nodeType === 3) {  // If this is a text node, replace the text

				if (el.nodeValue.trim() !== "") { // Ignore this node it it an empty text node
//console.log(el.nodeValue);
					var elementValue = el.nodeValue;
					if( elementValue.indexOf( sourceText ) !== -1 ){
_testObj.logMsg = "replace "+elementValue+" with replaceText";
func.logAlert( _testObj.logMsg, "info");
						el.nodeValue = replaceText;
					}

				}

			} else { // Else recurse on this node
				replaceTextNodes(el);
			}

		});
	}//end

	document.querySelector("#btn1").addEventListener("click", function(){
		var rootElement = document.querySelector("#demo1");
		replaceTextNodes( rootElement );
	});//end event


});//end load


//-------------- DEMO0
	document.querySelector("#btn0").addEventListener("click", function(){
		var sourceText = "RandomText";
		var replaceText = "Hello world";
		var rootElement = document.querySelector("#demo0");
		rootElement.innerHTML = rootElement.innerHTML.replace(new RegExp( sourceText, "g"), replaceText);
	});//end event


//-------------- DEMO2
//https://question-it.com/questions/290767/bolee-bystryj-sposob-zameny-teksta-vo-vseh-elementah-dom
//https://developer.mozilla.org/en-US/docs/Web/API/TreeWalker
//https://techarks.ru/qa/javascript/zamena-teksta-s-pomoshyu-tree-NP/
	function testTreeWalker( rootElement ){

		//var sourceText = /8 800 700–69–51/g;
		//var sourceText = /8 800 700–69–51|8 383 380-01–01/gi;
		var sourceText = /8 800 700–69–51|8 383 380-01-01/gi;
		var replaceValue = "8 (383) 258-56-41";

		var allTextNodes = document.createTreeWalker (
			rootElement,  // root node
			NodeFilter.SHOW_TEXT,  // filtering only text nodes
			null,
			false
		);
		var tmptxt, tmpnode;
		
		while ( allTextNodes.nextNode() ) {
			tmpnode = allTextNodes.currentNode;
			tmptxt = tmpnode.nodeValue;
			tmpnode.nodeValue = tmptxt.replace( sourceText, replaceValue );
/*
			tmpnode.nodeValue = tmptxt.replace( sourceText,  function (match) {
	console.log(arguments);		
	//let result = str.replace(/\d+/g, );		
				return replaceValue; 
			});
*/
		}//next
	}//end


	function replacePhoneNumber( rootElement ){
		var sourceText = "8 800 700–69–51";
		var replaceValue = "8 (383) 258-56-41";

		//filter search values, phone number, cut country code
		sValue = sourceText.replace(/\D/g,'');
		sValue = sValue.substring(1, sValue.length);

		var allTextNodes = document.createTreeWalker (
			rootElement,  // root node
			NodeFilter.SHOW_TEXT,  // filtering only text nodes
			null,
			false
		);
		
		while ( allTextNodes.nextNode() ) {

			// if it's not empty(whitespaced) node
			if ( allTextNodes.currentNode.nodeValue.trim() ){  
				//replace all !!!
				//allTextNodes.currentNode.nodeValue =replaceValue;

				var elementValue = allTextNodes.currentNode.nodeValue;
				//filter value
				elementValue = elementValue.replace(/\D/g,'');
				elementValue = elementValue.substring(1, elementValue.length);
				var res = elementValue.indexOf(sValue) !== -1;
				if(res){
console.log(sValue, elementValue);
					allTextNodes.currentNode.nodeValue =replaceValue;
				}

			}

		}//next
	}//end


	document.querySelector("#btn2").addEventListener("click", function(){
		//var rootElement = document.body;
		var rootElement = document.querySelector("#demo2");
		testTreeWalker( rootElement );
	});//end event

	document.querySelector("#btn-replace-phone").addEventListener("click", function(){
		//var rootElement = document.body;
		var rootElement = document.querySelector("#demo2");
		replacePhoneNumber( rootElement );
	});//end event


//-------------- DEMO3
//https://question-it.com/questions/290767/bolee-bystryj-sposob-zameny-teksta-vo-vseh-elementah-dom
//https://developer.mozilla.org/en-US/docs/Web/API/NodeIterator
//https://coderlessons.com/articles/veb-razrabotka-articles/masterstvo-html5-obkhod-dereva

//var replaceValue = "8 (383) 258-56-41";

function textFilter(node) {
	// if .nodeType is 3 (3 is text, 1 is element)
	if (node.nodeType === 3) {
		if ( node.nodeValue.trim() !== "") { // Ignore this node it it an empty text node
			node.nodeValue = 'helloWorld';
			return NodeFilter.FILTER_ACCEPT;
		}
	}
	return NodeFilter.FILTER_SKIP;
}//end

function testNodeIterator( rootNode ) {
	var iterator = document.createNodeIterator(
			rootNode, 
			NodeFilter.SHOW_TEXT, 
			textFilter
	);
//Advance to the next sibling or descend to node's children nodes 
	var node = iterator.nextNode();

	while (node) {
		node = iterator.nextNode();
	}//next
}//end

	document.querySelector("#btn-iteraror").addEventListener("click", function(){
		//var rootElement = document.body;
		var rootElement = document.querySelector("#demo3");
		testNodeIterator( rootElement );
	});//end event

	var testEventElements = document.querySelectorAll(".test-event");
	testEventElements.forEach(function(el, index){
//console.log(arguments);
		el.addEventListener("click", function(e){
console.log(e.type, e.target);
		});//end event
	});//next


//window.onload = function(){}//end load()
//===============================
/*
	func.addEvent( 
		_testObj["btnSave"], 
		"click", 
		function(e){
//console.log( e );
			var dataURL = _testObj["canvas"].toDataURL();//PNG
console.log(dataURL)	;
			//_saveImage();
			_testObj["btnSave"].href = dataURL;
		}
	);//end event
*/


</script>


</body>
</html>
